#!/bin/sh -ex

DB_NAME=gitlab_production
DB_USER=gitlab
DB_PASS=$(mcookie)

ADMIN_MAIL=admin@example.com
ADMIN_PASS=turnkey
DOMAIN=git.example.com

GIT=/home/git
GITLAB=/home/gitlab

SRC=/usr/local/src

exec_git() {
    sudo -u git -H sh -c "PATH=\$PATH:$GIT/bin; $@"
}

exec_gitlab() {
    sudo -u gitlab -H sh -c "$@"
}

# unpack and install ruby19 (if pre-build is available, use it)
if [ -e $SRC/ruby-1.9.*-build.tar.gz ]; then
    tar -zxf $SRC/ruby-1.9.*-build.tar.gz -C $SRC
    cd $SRC/ruby-1.9.*
    make install
else
    tar -zxf $SRC/ruby-1.9.*.tar.gz -C $SRC
    cd $SRC/ruby-1.9.*
    ./configure
    make
    make install
fi

# install rubygems
tar -zxf $SRC/rubygems-*.tgz -C $SRC
cd $SRC/rubygems-*
ruby setup.rb

# install gems
cd $SRC/gems
gem install --local --no-rdoc --no-ri *.gem

# install backported python-passlib
dpkg -i $SRC/python-passlib_*.deb

# create users
adduser --system --shell /bin/sh --group --disabled-password --home $GIT git
adduser --disabled-login --ingroup git --gecos 'gitlab' gitlab

# install gitolite
exec_git "tar -zxf $SRC/gitlabhq-gitolite-*.tar.gz -C $GIT"
exec_git "mv $GIT/gitlabhq-gitolite-* $GIT/gitolite"

exec_git "cat >$GIT/.profile<<EOF
PATH=\$PATH:/home/git/bin
export PATH
EOF"

exec_git "$GIT/gitolite/src/gl-system-install"
exec_git "sed -i 's/0077/0007/g' $GIT/share/gitolite/conf/example.gitolite.rc"

# setup gitlab ssh related and permissions
exec_gitlab "ssh-keygen -q -N '' -t rsa -f $GITLAB/.ssh/id_rsa"
exec_gitlab "cat >$GITLAB/.ssh/config<<EOF
Host localhost
    StrictHostKeyChecking no
EOF"

cp $GITLAB/.ssh/id_rsa.pub $GIT/gitlab.pub
chmod 777 $GIT/gitlab.pub
exec_git "gl-setup -q $GIT/gitlab.pub"

chmod -R g+rwX $GIT/repositories/
chown -R git:git $GIT/repositories/

# start services
/etc/init.d/mysql start

# setup database
MYSQL_BATCH="mysql --user=root --password=$MYSQL_PASS --batch"
MYSQL_ADMIN="mysqladmin --user=root --password=$MYSQL_PASS"

$MYSQL_ADMIN create $DB_NAME --default-character-set=utf8;
$MYSQL_BATCH --execute "grant all privileges on $DB_NAME.* to $DB_USER@localhost identified by '$DB_PASS'; flush privileges;"

# stop services
/etc/init.d/mysql stop

