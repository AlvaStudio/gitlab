#!/bin/sh -ex

DB_NAME=gitlab_production
DB_USER=gitlab
DB_PASS=$(mcookie)

ADMIN_MAIL=admin@example.com
ADMIN_PASS=turnkey
DOMAIN=git.example.com

GIT=/home/git
GITLAB=/home/gitlab

SRC=/usr/local/src

exec_git() {
    sudo -u git -H sh -c "PATH=\$PATH:$GIT/bin; $@"
}

exec_gitlab() {
    sudo -u gitlab -H sh -c "$@"
}

# unpack and install ruby19 (if pre-build is available, use it)
if [ -e $SRC/ruby-1.9.*-build.tar.gz ]; then
    tar -zxf $SRC/ruby-1.9.*-build.tar.gz -C $SRC
    cd $SRC/ruby-1.9.*
    make install
else
    tar -zxf $SRC/ruby-1.9.*.tar.gz -C $SRC
    cd $SRC/ruby-1.9.*
    ./configure
    make
    make install
fi

# install rubygems
tar -zxf $SRC/rubygems-*.tgz -C $SRC
cd $SRC/rubygems-*
ruby setup.rb

# install gems
cd $SRC/gems
gem install --local --no-rdoc --no-ri *.gem

# install backported python-passlib
dpkg -i $SRC/python-passlib_*.deb

