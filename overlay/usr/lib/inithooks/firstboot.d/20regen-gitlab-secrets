#!/bin/bash -e
# regenerate gitlab secrets

. /etc/default/inithooks

# secret token
TOKEN=$(mcookie)$(mcookie)$(mcookie)$(mcookie)
CONF=/home/gitlab/gitlab/config/initializers/secret_token.rb
sed -i "s|secret_token.*|secret_token = '$TOKEN'|" $CONF

# mysql password
PASSWORD=$(mcookie)
CONF=/home/gitlab/gitlab/config/database.yml
sed -i "s/password:\(.*\)/password: \"$PASSWORD\"/" $CONF
$INITHOOKS_PATH/bin/mysqlconf.py --user=gitlab --pass="$PASSWORD"

# sshkey
GITLAB_KEY=/home/gitlab/.ssh/id_rsa
GITPUB_KEY=/home/git/gitlab.pub
rm -f ${GITLAB_KEY}*
rm -f ${GITPUB_KEY}
sudo -H -u gitlab ssh-keygen -q -f $GITLAB_KEY -N '' -t rsa 
cp ${GITLAB_KEY}.pub ${GITPUB_KEY}
chmod 777 ${GITPUB_KEY}

# reconfigure gitolite to use updated key
sudo -u git -H sh -c "PATH=$PATH:/home/git/bin; gl-setup -q $GITPUB_KEY"

